<div id="field-mappings-editor" style="margin-bottom: 10px;">
  <div style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 15px;">
    <div style="flex: 1; border: 1px solid #ccc; border-radius: 4px; padding: 10px; background: #383838;">
      <h4 style="margin: 0 0 8px 0; color: #f3f2f2;">CSV Column Indices</h4>
      <p style="font-size: 0.85em; color: #ebebeb; margin: 0 0 10px 0;">
        Add rows below to map CSV columns (0-based index) to model fields.
      </p>
      <div id="mapping-rows"></div>
      <button type="button" id="add-mapping-row" style="margin-top: 8px; padding: 4px 12px; background: #417690; color: #fff; border: none; border-radius: 3px; cursor: pointer;">
        + Add Mapping
      </button>
    </div>
    <div style="flex: 1; border: 1px solid #ccc; border-radius: 4px; padding: 10px; background: #383838;">
      <h4 style="margin: 0 0 8px 0; color: #333;">Available Model Fields</h4>
      <div id="fields-reference">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 4px 8px; border-bottom: 2px solid #ddd;">Field Name</th>
              <th style="text-align: left; padding: 4px 8px; border-bottom: 2px solid #ddd;">Type</th>
              <th style="text-align: center; padding: 4px 8px; border-bottom: 2px solid #ddd;">Required</th>
              <th style="text-align: center; padding: 4px 8px; border-bottom: 2px solid #ddd;">Mapped</th>
            </tr>
          </thead>
          <tbody id="fields-reference-body"></tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="mapping-validation-errors" style="display: none; padding: 8px 12px; background: #fef0f0; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24; margin-bottom: 10px;"></div>
  <details style="margin-bottom: 8px;">
    <summary style="cursor: pointer; color: #417690; font-weight: bold;">Raw JSON (advanced)</summary>
    <div style="margin-top: 5px;">
      <textarea name="{{ widget.name }}" id="{{ widget.attrs.id }}"
        {% for attr_name, attr_value in widget.attrs.items %}
          {% if attr_name != "id" %} {{ attr_name }}="{{ attr_value }}"{% endif %}
        {% endfor %}
        style="width: 100%; font-family: monospace; font-size: 0.9em;"
      >{{ widget.value }}</textarea>
    </div>
  </details>
</div>

<script>
(function() {
  var salesFields = {{ widget.sales_fields_json|safe }};
  var purchaseFields = {{ widget.purchase_fields_json|safe }};

  function getRecordType() {
    var el = document.getElementById('id_record_type');
    return el ? el.value : 'sales';
  }

  function getFieldsForType(recordType) {
    return recordType === 'purchase' ? purchaseFields : salesFields;
  }

  function getCurrentMappings() {
    var textarea = document.getElementById('{{ widget.attrs.id }}');
    try {
      var val = JSON.parse(textarea.value);
      if (val && typeof val === 'object' && !Array.isArray(val)) return val;
    } catch(e) {}
    return {};
  }

  function syncToTextarea(mappings) {
    var textarea = document.getElementById('{{ widget.attrs.id }}');
    textarea.value = JSON.stringify(mappings, null, 2);
  }

  function renderFieldsReference() {
    var fields = getFieldsForType(getRecordType());
    var mappings = getCurrentMappings();
    var mappedFields = new Set(Object.values(mappings));
    var tbody = document.getElementById('fields-reference-body');
    tbody.innerHTML = '';
    fields.forEach(function(f) {
      var tr = document.createElement('tr');
      var isMapped = mappedFields.has(f.name);
      var bgColor = f.required && !isMapped ? '#fff3cd' : (isMapped ? '#d4edda' : '#fff');
      tr.style.backgroundColor = bgColor;
      tr.innerHTML =
        '<td style="color: black; padding: 4px 8px; border-bottom: 1px solid #eee;">' + f.name + (f.required ? ' <strong style="color: #c00;">*</strong>' : '') + '</td>' +
        '<td style="padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 0.85em; color: #666;">' + f.type + '</td>' +
        '<td style="text-align: center; padding: 4px 8px; border-bottom: 1px solid #eee; color: black;">' + (f.required ? 'Yes' : 'No') + '</td>' +
        '<td style="text-align: center; padding: 4px 8px; border-bottom: 1px solid #eee; color: black;">' + (isMapped ? '&#10003;' : '&#10007;') + '</td>';
      tbody.appendChild(tr);
    });
    validateMappings();
  }

  function validateMappings() {
    var fields = getFieldsForType(getRecordType());
    var mappings = getCurrentMappings();
    var mappedFields = new Set(Object.values(mappings));
    var missing = [];
    fields.forEach(function(f) {
      if (f.required && !mappedFields.has(f.name)) {
        missing.push(f.name);
      }
    });
    var errDiv = document.getElementById('mapping-validation-errors');
    if (missing.length > 0) {
      errDiv.style.display = 'block';
      errDiv.innerHTML = '<strong>Missing required fields:</strong> ' + missing.join(', ');
    } else {
      errDiv.style.display = 'none';
    }
  }

  function buildFieldOptions(selectedValue) {
    var fields = getFieldsForType(getRecordType());
    var html = '<option value="">-- select field --</option>';
    fields.forEach(function(f) {
      var label = f.name + (f.required ? ' *' : '');
      var sel = (f.name === selectedValue) ? ' selected' : '';
      html += '<option value="' + f.name + '"' + sel + '>' + label + '</option>';
    });
    return html;
  }

  function renderMappingRows() {
    var mappings = getCurrentMappings();
    var container = document.getElementById('mapping-rows');
    container.innerHTML = '';
    var entries = Object.entries(mappings).sort(function(a, b) { return parseInt(a[0]) - parseInt(b[0]); });
    entries.forEach(function(entry) {
      addMappingRow(entry[0], entry[1], container);
    });
  }

  function addMappingRow(colIndex, fieldName, container) {
    if (!container) container = document.getElementById('mapping-rows');
    var row = document.createElement('div');
    row.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 4px;';
    row.innerHTML =
      '<label style="font-size: 0.85em; width: 80px;">Column index:</label>' +
      '<input type="number" min="0" value="' + (colIndex || '') + '" style="width: 60px; padding: 3px;" class="mapping-col-index">' +
      '<label style="font-size: 0.85em; margin-left: 8px;">&#8594; Field:</label>' +
      '<select class="mapping-field-select" style="padding: 3px;">' + buildFieldOptions(fieldName) + '</select>' +
      '<button type="button" class="mapping-remove-btn" style="padding: 2px 8px; background: #ba2121; color: #fff; border: none; border-radius: 3px; cursor: pointer;">&#10005;</button>';
    container.appendChild(row);

    row.querySelector('.mapping-col-index').addEventListener('change', syncFromEditor);
    row.querySelector('.mapping-field-select').addEventListener('change', syncFromEditor);
    row.querySelector('.mapping-remove-btn').addEventListener('click', function() {
      row.remove();
      syncFromEditor();
    });
  }

  function syncFromEditor() {
    var rows = document.querySelectorAll('#mapping-rows > div');
    var mappings = {};
    rows.forEach(function(row) {
      var colInput = row.querySelector('.mapping-col-index');
      var fieldSelect = row.querySelector('.mapping-field-select');
      var col = colInput.value.trim();
      var field = fieldSelect.value;
      if (col !== '' && field !== '') {
        mappings[col] = field;
      }
    });
    syncToTextarea(mappings);
    renderFieldsReference();
  }

  document.getElementById('add-mapping-row').addEventListener('click', function() {
    var mappings = getCurrentMappings();
    var maxIndex = -1;
    Object.keys(mappings).forEach(function(k) {
      var n = parseInt(k);
      if (n > maxIndex) maxIndex = n;
    });
    addMappingRow(maxIndex + 1, '');
  });

  var recordTypeEl = document.getElementById('id_record_type');
  if (recordTypeEl) {
    recordTypeEl.addEventListener('change', function() {
      renderMappingRows();
      renderFieldsReference();
    });
  }

  var textarea = document.getElementById('{{ widget.attrs.id }}');
  if (textarea) {
    textarea.addEventListener('change', function() {
      renderMappingRows();
      renderFieldsReference();
    });
  }

  renderMappingRows();
  renderFieldsReference();
})();
</script>
